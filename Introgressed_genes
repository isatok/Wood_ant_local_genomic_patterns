###### Extract genes in the regions of interest and find their functional annotation ######

cd /scratch/project_2001443/barriers_introgr_formica_112024/introgressed_genes
sinteractive --account project_2001443 --mem 3000

module load biokit
GFF=/scratch/project_2001443/reference_genome/Faqxpol_genome_annotation_v1.gff3
REF=/scratch/project_2001443/reference_genome/Formica_hybrid_v1_wFhyb_Sapis.fa

### Study potential climatic adaptation, i.e. study regions that have introgressed only from F. pol to Finnish F. aqu ###

## A. extract multiple regions (all consequtive regions with elevated introgression signal)
GFFREG=genes_scaff06_pol_to_aqufi.gff3
FASTAREG=genes_scaff06_pol_to_aqufi.fasta
awk '$1 == "Scaffold06" && $4 >= 7321085 && $5 <= 7432689 && $3 == "gene"' $GFF > $GFFREG
bedtools getfasta -fi $REF -bed $GFFREG -fo $FASTAREG

## B. extract only the window with the strongest introgression signal (among multiple consequtive ones)
GFFREG2=genes_1window_scaff06_pol_to_aqufi.gff3
FASTAREG2=genes_1window_scaff06_pol_to_aqufi.fasta
awk '$1 == "Scaffold06" && $4 >= 7342056 && $5 <= 7404659 && $3 == "gene"' $GFF > $GFFREG2
bedtools getfasta -fi $REF -bed $GFFREG2 -fo $FASTAREG2

## Let's use CSC instructions to do the BLAST/ find functional annotations for the extracte regions:

cd /scratch/project_2001443/barriers_introgr_formica_112024/introgressed_genes
sinteractive --account project_2001443 --mem 12000 --cores 4

module load biokit
FASTAREG2=genes_1window_scaff06_pol_to_aqufi.fasta

blastx -query $FASTAREG2 -db nr -num_threads 4 -out results_introgressed_genes_climate_nr.out -evalue 1e-3 -outfmt 7 -max_target_seqs 5
#the runtime for above was xx and the memory consumption was xx

blastn -query $FASTAREG2 -db nt -num_threads 4 -out results_introgressed_genes_climate_nr.out -evalue 1e-3 -outfmt 7 -max_target_seqs 5
#the runtime for above was xx and the memory consumption was xx

#### If this consumes too much memory and time, let's use the automated batch blast #### 
# https://docs.csc.fi/apps/blast/

module load biokit
cd /scratch/project_2001443/barriers_introgr_formica_112024/introgressed_genes
sinteractive --account project_2001443 --mem 32000 --cores 4

pb blastn -db nt -query $FASTAREG2 -out results_introgressed_genes_climate_pb_nt.out -evalue 1e-3 -outfmt 7 -max_target_seqs 5
#Close the monitoring by pressing Ctrl-c. After that you can start other tasks or log out from Puhti.
#To reconnect to your pb blast job, go to scratch and run command: > blast_clusterrun
#This lists the temporary directories of your unfinished pb blast jobs. 
#You can check the job number of your blast job from the directory name. 
#Use this number with -jobid option to define the pb blast job you wish to reconnect to.
# > blast_clusterrun -jobid some-number




