
###
### Neighbour-joining tree
###

#Either create the tree using dataset *with missing data*
njs(X, fs = 15)
#https://rdrr.io/cran/ape/man/njs.html
#X: a distance matrix.
#fs: argument s of the agglomerative criterion: it is coerced as an integer and must at least equal to one.

#Or create the tree with *no missing data*
nj(X)
#X: a distance matrix; may be an object of class “dist”.

## Follow Sean's recent NJ pipeline in 
https://github.com/seanstankowski/Littorina_reproductive_mode/blob/main/3_genomeWide_relationships/NJtree_phylonet/buildTrees.ipynb

#the data seems to be needed to be in phylip format "variants_only_108_VCF_MAC2_minQ30_maxmiss1.0.recode.min4.phy"
#converted from VCF. apply mac2 filtering, and they did this with no missing data. BUT WHAT IS THE MIN4 FILTERING?

#The VCF file was converted to phylip format using the script vcf2phylip (28).  E. M. Ortiz, vcf2phylip v2.0: 
#convert a VCF matrix into several matrix formats for phylogenetic analysis (2019; https://zenodo.org/record/2540861).

###
### Try this out with the phased dataset since it has no missing data (imputed) and it has the outgroup.
###

cd /scratch/project_2001443/barriers_introgr_formica/nj_tree
VCFIN=/scratch/project_2001443/barriers_introgr_formica/vcf/phasing/shapeit/phased_with_outgroup_gtfix.vcf.gz

#See if I can find duplicates:
sinteractive...
module load biokit
gunzip -c $VCFIN | grep "Scaffold27" | cut -f2 | uniq -D


########OK SO EXSECTA HAS DUPLICATES. NEED TO FILTER ONLY BIALLELIC SNPS... NO, NEED ONLY ONE ALLELE PER SITE. HOW TO DO BETTER GENOTYPING?

#Enhance F. exsecta genotyping, exclude indels from the vcf and see if F. exsecta still has duplicate sites

sinteractive...
module load biokit

#Go to phylogeny dir
cd /scratch/project_2001443/barriers_introgr_formica/nj_tree

#Get the F. exsecta vcf
#(see https://github.com/isatok/Wood_ant_local_genomic_patterns/blob/main/3_Prep4trees%26TWISST/2_Add_outgroup.sh how to achieve it)
EXSVCF=/scratch/project_2001443/barriers_introgr_formica/vcf/phasing/shapeit/Fexs_nodupl_phased_sites.vcf.gz

#Copy it and its index to phylogeny dir
cp $EXSVCF $EXSVCF.tbi .

#Soft and hard filter indels to see if this solves the issue
bcftools filter --threads 8 -Oz -i 'TYPE!="indel"' -s NonSnp -m+ $EXSVCF > Fexs_nodupl_phased_sites_noindels.vcf.gz
bcftools filter --threads 8 -Oz -i 'TYPE!="indel"' -m+ $EXSVCF > Fexs_nodupl_phased_sites_noindels_hardfilt.vcf.gz
#bcftools filter --threads 8 -Oz -e 'TYPE!="snp"' -s NonSnp -m+ $EXSVCF > filtered_xx.vcf.gz

#Compare the phased VCF, based on which the called genotypes were defined, and the indel-filtered exsecta vcf, to see if this removed their differences

PHASEDVCF=/scratch/project_2001443/barriers_introgr_formica/vcf/phasing/shapeit/all_samples.DP8.hwe.AN10.noScaff00.mac2.whap.shapeit.allScafs.vcf.gz 
FILTEXS=Fexs_nodupl_phased_sites_noindels_hardfilt.vcf.gz
bcftools isec -p isec_output -Oz $PHASEDVCF $FILTEXS


    isec_output/0000.vcf.gz would be variants unique to 1.vcf.gz
    isec_output/0001.vcf.gz would be variants unique to 2.vcf.gz
    isec_output/0002.vcf.gz would be variants shared by 1.vcf.gz and 2.vcf.gz as represented in 1.vcf.gz
    isec_output/0002.vcf.gz isec_output/0003.vcf.gz would be variants shared by 1.vcf.gz and 2.vcf.gz as represented in 2.vcf.gz

#This doesn't work: isec doesn't recognise these are same positions or there are too many differences. Let's see what has been filtered out by indel
#filtering and if there are duplicates left
bcftools isec -p isec_output_2 -Oz $EXSVCF $FILTEXS #less -S isec_output_2/0000.vcf.gz | wc -l: 698 INDELS removed

#there are still duplicates, see e.g.
gunzip -c $FILTEXS | grep "Scaffold27" | cut -f2 | uniq -D #1307020 1794249 3009120 3400400
#what are they?
bcftools view -H -r Scaffold27:1307020 $FILTEXS #ALL ARE INDELS!

#There are altogether 1334/2 = 667 duplicates in the unfiltered exsecta file
gunzip -c $EXSVCF | cut -f2 | uniq -D | wc -l #1334

#Try then filtering differently to catch them all
bcftools filter --threads 8 -Oz -e 'TYPE!="snp"' -m+ $EXSVCF > Fexs_nodupl_phased_sites_noindels_hardfilt_2.vcf.gz
bcftools filter --threads 8 -Oz -e 'TYPE!="snp"' -m+ $EXSVCF > Fexs_nodupl_phased_sites_noindels_hardfilt_2.vcf.gz

#How many duplicates left? 0!
gunzip -c Fexs_nodupl_phased_sites_noindels_hardfilt_2.vcf.gz | cut -f2 | uniq -D | wc -l #0

#How many sites now? --> 74524 #NO THIS WAS NO GOOD, it filtered out also monomorphic sites
bcftools index -t Fexs_nodupl_phased_sites_noindels_hardfilt_2.vcf.gz 
bcftools index -n Fexs_nodupl_phased_sites_noindels_hardfilt_2.vcf.gz  #74524
bcftools index -n $EXSVCF 

#Maybe try to exclude indels and monomorphic sites
bcftools filter --threads 8 -Oz -e 'TYPE!="ref" && TYPE!="snp"' -m+ $EXSVCF > Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz
bcftools index -t Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz 
bcftools index -n Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz  #524313

#Alright, this is quite close to 524873 SNPs in Fexs_nodupl_phased_sites.vcf.gz (SNPs of the bed list found from exsecta)
#Now do we have duplicates?
gunzip -c Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz | cut -f2 | uniq -D | wc -l #214 /2 =107
#yes, still 107. WHAT THE F ARE THEY???

gunzip -c Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz | grep "Scaffold01" | cut -f2 | uniq -D | wc -l #214 /2 =107
[satokan1@r18c03 nj_tree]$ gunzip -c Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz | grep "Scaffold01" | cut -f2 | uniq -D 
2442227
5047119
5422749
7356857
8384924
9728793
12764611
13278326

bcftools view -H -r Scaffold01:2442227 Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz #mnp
bcftools view -H -r Scaffold01:5047119 Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz #mnp
bcftools view -H -r Scaffold01:5422749 Fexs_nodupl_phased_sites_noindels_hardfilt_3.vcf.gz #mnp

#hte latter always seems to have multi-nucleotide ref allele! so maybe remove duplicates such taht 
#the latter can be always thrown away and.check how many duplicates. we have thenn. there was seom
#simple command for such.

e.g. 
Scaffold01	2442227	.	C	.	30.2381	P
Scaffold01	2442227	.	CA	.	29.
the info field has "INDEL" written but should get a tool that understands that...

########
####### CONTINUE FROM HERE ###############
########


###
### ASTRAL - maybe not to be used after all?
###

Does it go like this:

# 1) Take the genome annotation file (& scp it to Puhti)
/Users/inaukkar/Downloads/Faqxpol_genome_annotation_v1.gff3.gz
ANNOT=Faqxpol_genome_annotation_v1.gff3.gz

# 2) Extract gene regions from there https://www.biostars.org/p/98725/
gff2bed < annotations.gff | grep -w 'gene' | cut -f1-4 > genes.bed

# 3) Use the gene coordinates to build gene trees https://github.com/simonhmartin/genomics_general#trees-for-sliding-windows,
# maybe with "window can be defined based on genomic coordinates (--windType coord)", no outgroup (unrooted), all non-admixed samples

# 4) Use ASTRAL to make a phylogeny from these gene trees https://github.com/smirarab/ASTRAL
java -jar astral.5.7.8.jar -i in.tree -o out.tre 2>out.log
# also include "-a" option: When multiple individuals from the same species are available, you can ask ASTRAL to force them to be together in the species tree. 
# To do this, a mapping file needs to be provided using the -a option: one species per line; species_name [number of individuals] individual_1 individual_2 ...

#QUESTIONS:
# Can I use my imputed and phased SNP-data to build the gene trees? Is it correct to define the tree regions by using "gene" annotations from the annotation file?
