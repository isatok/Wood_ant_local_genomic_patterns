#This is to make a gene tree to confirm the F rufa group phylogeny

#Subset 73 inds used in NJ-tree, phase them, and add F. exsecta back

###
### PREP VCF ### ------------------------------------
###

sinteractive --account project_2001443 --mem 4000
VCF=/scratch/project_2001443/barriers_introgr_formica_revision/barriers_introgr_formica_112024/dsuite/outgroup_prep/DP8.93inds.AN10.noScaff0003.mac2.Fexs.SNP.gtFix.vcf.gz
VCF73=/scratch/project_2001443/barriers_introgr_formica_revision/barriers_introgr_formica_112024/vcf/filt/DP8.93inds.AN10.noScaff0003.mac2.Fexs.SNP.gtFix.73inds.vcf.gz

bcftools view -S ind.list -Oz -o $VCF73 $VCF && bcftools index $VCF73

#List individuals:
bcftools query -l $VCF73 > ${VCF73%.vcf.gz}.list


###
### RUN WHATSHAP ### ------------------------------------
###


REF=/scratch/project_2001443/barriers_introgr_formica_revision/reference_genome/Formica_hybrid_v1_wFhyb_Sapis.fa
BAM=/scratch/project_2001443/barriers_introgr_formica_revision/barriers_introgr_formica_112024/bam/bam_all/

mkdir /scratch/project_2001443/barriers_introgr_formica_revision/whatshap
mkdir /scratch/project_2001443/barriers_introgr_formica_revision/whatshap/logs

# REMOVE UNNECESSARY FORMAT FIELDS (at least GQ causing problems) so WhatsHap is happy to run

bcftools annotate -x FORMAT/GL,FORMAT/PL,FORMAT/GQ -Oz -o master.whatsHapClean.vcf.gz $VCF73


###---whatshap.sh---### 

#!/bin/bash -l
#SBATCH -J whap
#SBATCH -o /scratch/project_2001443/barriers_introgr_formica_revision/whatshap/logs/whatshap_%a.out
#SBATCH -e /scratch/project_2001443/barriers_introgr_formica_revision/whatshap/logs/whatshap_%a.err
#SBATCH --account=project_2001443
#SBATCH -t 24:00:00
#SBATCH -p small
#SBATCH --array=1-73
#SBATCH --ntasks 1
#SBATCH --mem=25G
#SBATCH --mail-type=END

# modules
module load biokit
export PATH="/projappl/project_2001443/whatshapenv/bin:$PATH"

cd /scratch/project_2001443/barriers_introgr_formica_revision/whatshap

# Define paths
BAMDIR=/scratch/project_2001443/barriers_introgr_formica_revision/barriers_introgr_formica_112024/bam/bam_all/
masterVCF=/scratch/project_2001443/barriers_introgr_formica_revision/whatshap/master.whatsHapClean.vcf.gz
REF=/scratch/project_2001443/barriers_introgr_formica_revision/reference_genome/Formica_hybrid_v1_wFhyb_Sapis.fa
INDLIST=/scratch/project_2001443/barriers_introgr_formica_revision/barriers_introgr_formica_112024/vcf/filt/DP8.93inds.AN10.noScaff0003.mac2.Fexs.SNP.gtFix.73inds.list

# Define focal ind
ind=$(sed -n "$SLURM_ARRAY_TASK_ID"p $INDLIST)
indbam=${ind%%-*} #in the bam file names, inds sequenced earlier have only numbers as ids, whereas the vcf ids (and INDLIST) contain species info for these. Match these.

# 1. Extract single individual from VCF
bcftools view -s $ind $masterVCF -Ov | bgzip > ${ind}.vcf.gz &&\
bcftools index -t ${ind}.vcf.gz &&

# 2. Phase
echo "Start phasing ${ind}."

whatshap phase -o ${ind}.phased.vcf.gz --reference $REF \
               ${ind}.vcf.gz $BAMDIR/${indbam}_nodupl_*.bam &&\
bcftools index -t ${ind}.phased.vcf.gz &&
whatshap stats ${ind}.phased.vcf.gz --tsv=${ind}.phased.tsv

### end

###---whatshap.sh ends---### 


###
### MERGE INDIVIDUAL VCFs ### ------------------------------------
###

### Create a list of the phased vcf files
cd /scratch/project_2001443/barriers_introgr_formica_revision/whatshap
ls *.phased.vcf.gz > phased_vcf.list

### Run a batch job to merge the individual whatshap-phased vcf files into one vcf file

###---mergevcf.sh---### 

#!/bin/bash -l
#SBATCH -J mergevcf
#SBATCH -o /scratch/project_2001443/barriers_introgr_formica_revision/whatshap/logs/mergevcf_%a.out
#SBATCH -e /scratch/project_2001443/barriers_introgr_formica_revision/whatshap/logs/mergevcf_%a.err
#SBATCH --account=project_2001443
#SBATCH -t 02:00:00
#SBATCH -p small
#SBATCH --ntasks 1
#SBATCH --mem=5G

cd /scratch/project_2001443/barriers_introgr_formica_revision/whatshap
module load biokit

bcftools merge -l /scratch/project_2001443/barriers_introgr_formica_revision/whatshap/phased_vcf.list -Oz > master.whatsHapClean.whap.vcf.gz &&\
bcftools index -t master.whatsHapClean.whap.vcf.gz
###END

###---mergevcf.sh ends---### 


###
### RUN SHAPEIT ### ------------------------------------
###

VCF=/scratch/project_2001443/barriers_introgr_formica_revision/whatshap/master.whatsHapClean.whap.vcf.gz



### Create a list of scaffolds

cd /scratch/project_2001443/barriers_introgr_formica_revision/shapeit
for i in {01..27}; do echo "Scaffold$i"; done | grep -v "Scaffold03" > scaffold.list

### Run a batch job to phase the data with ShapeIt4

###---shpt4.sh---### 

#!/bin/bash -l
#SBATCH -J shpt4
#SBATCH -o /scratch/project_2001443/barriers_introgr_formica_revision/shapeit/logs/shpt4_Scaffold%a.out
#SBATCH -e /scratch/project_2001443/barriers_introgr_formica_revision/shapeit/logs/shpt4_Scaffold%a.err
#SBATCH --account=project_2001443
#SBATCH -t 06:00:00
#SBATCH -p small
#SBATCH --array=1-26
#SBATCH --ntasks 4
#SBATCH --mem=8G

cd /scratch/project_2001443/barriers_introgr_formica_revision/shapeit

#Path for the SHAPEIT4 executable
SHPT4PATH=/scratch/project_2001443/barriers_introgr_formica_revision/shapeit4_package/shapeit4-4.2.2/bin

mychr=$(sed -n "$SLURM_ARRAY_TASK_ID"p scaffold.list)

$SHPT4PATH/shapeit4.2 --input ../whatshap/master.whatsHapClean.whap.vcf.gz \
  --output "master.whatsHapClean.whap.shapeit."$mychr".vcf.gz" \
  --region $mychr --sequencing --thread 4 \
  --mcmc-iterations 10b,1p,1b,1p,1b,1p,1b,1p,1b,1p,1b,1p,10m --pbwt-depth 8 --use-PS 0.0001

### End of batch script

###---shpt4.sh ends---### 


###
### COMBINE CHROMOSOMES ### ------------------------------------
###

###---combineCHR.sh---###  

#!/bin/bash -l
#SBATCH -J shpt4
#SBATCH -o /scratch/project_2001443/barriers_introgr_formica_revision/shapeit/logs/combineCHR.out
#SBATCH -e /scratch/project_2001443/barriers_introgr_formica_revision/shapeit/logs/combineCHR.err
#SBATCH --account=project_2001443
#SBATCH -t 02:00:00
#SBATCH -p small
#SBATCH --ntasks 1
#SBATCH --mem=4G

cd /scratch/project_2001443/barriers_introgr_formica_revision/shapeit

## Combine all chromosomes
module load biokit

ls *vcf.gz > shapeit.file.list &&
bcftools concat -Oz -f shapeit.file.list -o master.whatsHapClean.whap.shapeit.allScafs.vcf.gz

### End of batch script

###---combineCHR.sh ends---###  


###
### ADD OUTGROUP ### ------------------------------------
###

# Combine outgroup + sample VCFs

# Subset exsecta from the initial master vcf
sinteractive --account project_2001443 --mem 4000

PHASEDVCF=/scratch/project_2001443/barriers_introgr_formica_revision/shapeit/master.whatsHapClean.whap.shapeit.allScafs.vcf.gz
MAINVCF=/scratch/project_2001443/barriers_introgr_formica_revision/barriers_introgr_formica_112024/dsuite/outgroup_prep/DP8.93inds.AN10.noScaff0003.mac2.Fexs.SNP.gtFix.vcf.gz
OUTVCF=/scratch/project_2001443/barriers_introgr_formica_revision/shapeit/Fexs.vcf.gz

bcftools index -t $PHASEDVCF 
bcftools view -S Fexs -Oz -o $OUTVCF $MAINVCF && bcftools index -t $OUTVCF

bcftools merge -Ou \
  $PHASEDVCF \
  $OUTVCF -Oz -o master.whatsHapClean.whap.shapeit.allScafs.outgroup.vcf.gz

  #Set missing genotypes (which are only in exsecta) to . instead of ./.
zcat master.whatsHapClean.whap.shapeit.allScafs.outgroup.vcf.gz | awk '{gsub(/\.\/\./,"."); print $0}' | bgzip > master.whatsHapClean.whap.shapeit.allScafs.outgroup.gtfix.vcf.gz

#Checked that the initial master vcf and the phased one with outgroup have same amount of loci (1890044).


###
### SUBSET CDS REGIONS, COMBINE IN GENES ### ------------------------------------
###

sinteractive...
mkdir phyml && cd phyml
module load biokit

ANNOT=/scratch/project_2001443/barriers_introgr_formica_revision/reference_genome/Faqxpol_genome_annotation_v1.gff3.gz
VCF=/scratch/project_2001443/barriers_introgr_formica_revision/outgroup/master.whatsHapClean.whap.shapeit.allScafs.outgroup.gtfix.vcf.gz

## Step 1 — Build a CDS BED
grep -P "\tCDS\t" $ANNOT \
| awk 'BEGIN{OFS="\t"}{print $1,$4-1,$5}' \
> cds.bed

## Step 2 — Restrict the VCF to CDS sites
bcftools view -R cds.bed $VCF -Oz -o cds_only.vcf.gz
bcftools index cds_only.vcf.gz

##remember to convert vcf to geno now! this is not in the instructions.

## Step 3 — Build gene windows (contiguous)
grep -P "\tgene\t" $ANNOT \
| awk 'BEGIN{OFS="\t"}{print $1,$4,$5,$9}' \
> gene_windows.coords

## Step 4 — Run phyml sliding windows
#CHECK THIS
phyml_sliding_windows.py \
  -v cds_only.vcf.gz \
  -c gene_windows.coords \
  -o cds_gene_trees \
  --minSites 50
