#Continue the work with a phylogeny

#Here starting with a vcf file /scratch/project_2001443/barriers_introgr_formica/vcf/filt/all_samples.DP8.hwe.AN10.noScaff00.mac2.vcf.gz that, in addition,
#has F. exsecta as the outgroup:

cd /scratch/project_2001443/barriers_introgr_formica/nj_tree    
sinteractive...
module load biokit

VCFIN=unphased_with_outgroup_dedupl_gtfix.vcf.gz #534202 variants, 102 samples

#Keep only individuals that have been identified nonadmixed (no detectable admixture based on ADMIXTURE, PCA, neighbour-joining tree; Satokangas et al. 2023 and Fig. SXX )
#as including admixed individuals would be unhelpful in constructing a species' phylogeny.

SAMPLELIST=nonadmixed_nj_sample_list.txt #81 inds

#Keep only selected individuals
zcat $VCFIN | bcftools view -S $SAMPLELIST | bgzip > unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz 
bcftools query -l unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz  | wc -l #81 inds; all good

#How much missing data per ind?
vcftools --gzvcf unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz  --missing-indv --out unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz.MISSING_DATA
sort -k 5 unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz.MISSING_DATA.imiss | column -t

#Keep only individuals with less than 10% missing data so that we'll have enough SNPs in the non-missing data SNP set
awk '$5 < 0.10 {print $1}' unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz.MISSING_DATA.imiss > nonadmixed_nj_sample_list_INDmaxmiss10.txt #70 inds; all good
zcat unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree.vcf.gz | bcftools view -S nonadmixed_nj_sample_list_INDmaxmiss10.txt | bgzip > unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10.vcf.gz 

# Keep only loci with no missing data and check the number of snps remaining
zcat unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10.vcf.gz | bcftools view -e 'F_MISSING > 0.0' | bgzip > unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss0.vcf.gz
bcftools index -t unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss0.vcf.gz
bcftools index -n unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss0.vcf.gz #115.393 SNPs

#2nd dataset: keep loci with 1% missing data; following Stankowski pipeline
zcat unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10.vcf.gz | bcftools view -e 'F_MISSING > 1.0' | bgzip > unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0.vcf.gz
bcftools index -t unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0.vcf.gz
bcftools index -n unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0.vcf.gz #534.202 SNPs i.e. all SNPs can be used!

#3rd dataset: check that the phylogeny holds even when Scaffold03 is filtered out:
vcftools --gzvcf unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0.vcf.gz --not-chr Scaffold03 --recode --stdout | bgzip > unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0_noScaff03.vcf.gz
bcftools index -t unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0_noScaff03.vcf.gz
bcftools index -n unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0_noScaff03.vcf.gz #495055 SNPs

### Convert to phylip
#The VCF file was converted to phylip format using the script vcf2phylip (28).  E. M. Ortiz, vcf2phylip v2.0: 
#convert a VCF matrix into several matrix formats for phylogenetic analysis (2019; https://zenodo.org/record/2540861).

wget https://github.com/edgardomortiz/vcf2phylip/archive/refs/tags/v2.8.zip 
unzip v2.8.zip

module load python-data
python ./vcf2phylip-2.8/vcf2phylip.py -i unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss0.vcf.gz -o Fexs -w
python ./vcf2phylip-2.8/vcf2phylip.py -i unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0.vcf.gz -o Fexs -w
python ./vcf2phylip-2.8/vcf2phylip.py -i unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0_noScaff03.vcf.gz -o Fexs -w

### NEXT MOVE TO R ! ###

#Get files to local 

scp satokan1@puhti.csc.fi:'/scratch/project_2001443/barriers_introgr_formica/nj_tree/unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss0.min4.phy' \
'/Users/inaukkar/Library/CloudStorage/OneDrive-UniversityofHelsinki/PhD/4_formica_local_genomics/Phylogeny/nj_tree'

scp satokan1@puhti.csc.fi:'/scratch/project_2001443/barriers_introgr_formica/nj_tree/unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0.min4.phy' \
'/Users/inaukkar/Library/CloudStorage/OneDrive-UniversityofHelsinki/PhD/4_formica_local_genomics/Phylogeny/nj_tree'

scp satokan1@puhti.csc.fi:'/scratch/project_2001443/barriers_introgr_formica/nj_tree/nonadmixed_nj_sample_list_INDmaxmiss10.txt' \
'/Users/inaukkar/Library/CloudStorage/OneDrive-UniversityofHelsinki/PhD/4_formica_local_genomics/Phylogeny/nj_tree'

scp satokan1@puhti.csc.fi:'/scratch/project_2001443/barriers_introgr_formica/nj_tree/unphased_with_outgroup_dedupl_gtfix_nonadmixed_NJ_tree_INDmaxmiss10_SNPmaxmiss1.0_noScaff03.min4.phy' \
'/Users/inaukkar/Library/CloudStorage/OneDrive-UniversityofHelsinki/PhD/4_formica_local_genomics/Phylogeny/nj_tree'
